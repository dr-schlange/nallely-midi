<!doctype html>

<html lang="en">

<head>
        <!-- Basic Metadata -->
        <meta charset="utf-8" />
        <meta name="HandheldFriendly" content="True" />
        <meta name="generator" content="Arise" />

        <title>How to make Nallely understand new MIDI devices · Nallely MIDI</title>
        <meta name="description" content="How to add a new MIDI device in Nallely">
        <meta name="author" content="Dr. Schlange">
        <!-- End Basic Metadata -->

        <!-- OpenGraph Metadata -->
        <meta property="og:site_name" content="Nallely MIDI" />
        <meta property="og:type" content="article" />
        <meta property="og:title" content="How to make Nallely understand new MIDI devices · Nallely MIDI" />
        <meta property="og:description" content="How to add a new MIDI device in Nallely" />
        <meta property="og:url" content="https://dr-schlange.github.io/nallely-midi/posts/add-new-midi-device/" />
        <meta property="og:image" content="https://dr-schlange.github.io/nallely-midi/posts/add-new-midi-device/" />
        <meta property="article:published_time" content="2025-07-10" />
        <meta property="article:modified_time" content="2025-07-10" />
        <!-- End OpenGraph Metadata -->

        <!-- Twitter Metadata -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="How to make Nallely understand new MIDI devices · Nallely MIDI" />
        <meta name="twitter:description" content="How to add a new MIDI device in Nallely" />
        <meta name="twitter:url" content="https://dr-schlange.github.io/nallely-midi/posts/add-new-midi-device/" />
        <meta name="twitter:image" content="https://dr-schlange.github.io/nallely-midi/posts/add-new-midi-device/" />
        <!-- End Twitter Metadata -->

        <!-- Favicon -->
        <link rel="apple-touch-icon" sizes="180x180" href="/nallely-midi/config/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/nallely-midi/config/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/nallely-midi/config/favicon/favicon-16x16.png">
        <link rel="manifest" href="/nallely-midi/config/favicon/site.webmanifest">
        <link rel="mask-icon" href="/nallely-midi/config/favicon/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="shortcut icon" href="/nallely-midi/config/favicon/favicon.ico">
        <meta name="msapplication-TileColor" content="#00aba9">
        <meta name="msapplication-config" content="/config/favicon/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">
        <!-- End Favicon -->

        <!-- Styesheet+Logo -->
        <style>
                html * {
                        font-family: monospace, sans-serif;
                }

                body {
                        background-color: #121619;
                        margin: 40px auto;
                        max-width: 650px;
                        padding: 0 10px;
                        color: #65f85a;
                }

                a {
                        color: #b8f1b4;
                }

                hr {
                        color: #65f85a;
                }

                .topbar a {
                        color: #65f85a;
                }
        </style>
        <link rel="stylesheet" href="/nallely-midi/config/highlight.css">
        <link rel="stylesheet" href="/nallely-midi/config/main.css">
        <div class="logo"><a href="/nallely-midi">
                        <pre id="logo">

  ██████   █████           ████  ████           ████                ██████   ██████ █████ ██████████   █████
░░██████ ░░███           ░░███ ░░███          ░░███               ░░██████ ██████ ░░███ ░░███░░░░███ ░░███
 ░███░███ ░███   ██████   ░███  ░███   ██████  ░███  █████ ████    ░███░█████░███  ░███  ░███   ░░███ ░███
 ░███░░███░███  ░░░░░███  ░███  ░███  ███░░███ ░███ ░░███ ░███     ░███░░███ ░███  ░███  ░███    ░███ ░███
 ░███ ░░██████   ███████  ░███  ░███ ░███████  ░███  ░███ ░███     ░███ ░░░  ░███  ░███  ░███    ░███ ░███
 ░███  ░░█████  ███░░███  ░███  ░███ ░███░░░   ░███  ░███ ░███     ░███      ░███  ░███  ░███    ███  ░███
  █████  ░░█████░░████████ █████ █████░░██████  █████ ░░███████     █████     █████ █████ ██████████   █████
░░░░░    ░░░░░  ░░░░░░░░ ░░░░░ ░░░░░  ░░░░░░  ░░░░░   ░░░░░███    ░░░░░     ░░░░░ ░░░░░ ░░░░░░░░░░   ░░░░░
          ███ ░███
        ░░██████
                                                      ░░░░░░                                               </pre>
                </a></div>

        <!-- End Styles+Logo -->

        <!-- Navigation -->
        <nav class="topbar">
                <a href="/nallely-midi">Home</a> ⟛ <a href="/nallely-midi/news">News</a> ⟛ <a
                        href="/nallely-midi/posts">Posts</a> ⟛ <a
                        href="https://www.youtube.com/playlist?list=PL0S9whcJCHAgP9Gb_Z3FyaJOYngbdR-mj">Demos</a> ⟛ <a
                        href="https://github.com/dr-schlange/nallely-midi">GitHub</a> ⟛ <a
                        href="https://github.com/dr-schlange/nallely-midi/releases/latest">Download</a>
        </nav>
        <!-- End Navigation -->
</head>

<body><p class="date">// 2025-07-10 <i>by Dr. Schlange</i></p>
<h1 id="how-to-add-a-new-midi-device-in-nallely">How to add a new MIDI
device in Nallely</h1>
<p>By default, Nallely understands three MIDI devices as builtins:</p>
<ul>
<li>Korg NTS-1,</li>
<li>Korg Minilogue,</li>
<li>Akai MPD32 (specific configuration).</li>
</ul>
<p>This doesn’t mean that Nallely cannot understand other MIDI devices,
it just means that we need to manually add new MIDI devices to Nallely.
Nallely works by reflecting on an abstraction of the MIDI device through
a reflexive Python API that is dedicated to each MIDI device. The Python
API is described using an internal Python DSL that allows you to declare
in a simple way the MIDI device. So, to make a new MIDI device
understood by Nallely, we need to produce this Python API. There is
basically 3 ways of doing it by:</p>
<ol type="1">
<li>generating the Python API using Nallely from a YAML
description,</li>
<li>generating the Python API using Nallely from a CSV description
coming from the <a href="https://midi.guide/">MIDI CC &amp; NRPN
database</a>,</li>
<li>writing the Python API by hand.</li>
</ol>
<p>In this article, we will make Nallely understand the Roland S-1 mini
synth, by reviewing the three methods so you can decide which one fits
you the best. For each method we show a brief overview of the process -
“from a file to a living neuron in Nallely” - we then show the specific
syntax involved in the form of a small tutorial. We finally reflect on
the key points related to each method.</p>
<p><strong>NOTE</strong>: Among the three methods, there is no “best
method”. Each of them is valid, it’s just a matter of taste, but the one
that generates the Python API code from the CSV provided by the
<code>MIDI CC &amp; NRPN database</code> might require a little bit of
attention as - despite the efforts made by the authors to harmonize the
descriptions - some CSV descriptions are not entirely well formed.</p>
<p><strong>Limitations</strong>: the current version of the Python
internal DSL for describing MIDI devices supports LSB CC description,
keyboard, and pitchwheel. Currently MSB CC and sysex messages are not
supported, but they will in future version. More importantly, the Python
internal DSL to describe MIDI devices will always be retro compatible.
If for some reasons in the future the internal DSL changes, automatic
converters will be provided (it should be only a matter of doing AST
transformation, so not a big deal).</p>
<h2 id="generate-the-python-api-from-a-yaml-description">Generate the
Python API from a YAML description</h2>
<p>This method is perhaps the simplest in the sense that you just have
to write a YAML file, by referring to the MIDI implementation chart of
your device. In this section we focus on the Roland S-1. We first
describe the process at coarse granularity, then we write a first
incomplete version that we directly integrate into Nallely, then we
iterate on our first version to get the full MIDI device’s Python API
automatically generated. Finally, we conclude over this methods, the
gotchas and important points to consider.</p>
<h3 id="process-overview">Process overview</h3>
<p>This method considers as entry point a YAML description. This
description is the main and only artifact that needs to be written by
hand. This YAML description is then fed to the API code generator
provided by Nallely, which will produce the Python API in a dedicated
Python module which can be directly added to a Nallely session.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>YAML file --(nallely generate)--&gt; dedicated Python API</span></code></pre></div>
<p>If some adjustments needs to be done later, the generated Python
module shouldn’t be modified by hand, only the YAML description should,
then the code have to be generated again using Nallely.</p>
<h4 id="yaml-format-understood-by-nallely">YAML format understood by
Nallely</h4>
<p>Nallely uses a specific structured format for the YAML description as
we can see in the following snippet.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">manufacturer name</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">MIDI device name</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">section 1</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">parameter name</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">cc</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">description</span><span class="kw">:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">min</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">max</span><span class="kw">:</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="at">                </span><span class="fu">init</span><span class="kw">:</span></span></code></pre></div>
<p>The <code>manufacturer name</code> is the name of the company that
built the device. This entry is currently not really used, but will be
in the future. It will help to sort various devices, and search them by
manufacturer/brand name (for example). If you have multiple devices of
this brand, it’s better to use the same name each time, just for harmony
purpose.</p>
<p>As sub-section of the <code>manufacturer name</code>, we have the
device name. This information is used in the generated code to try to
automatically connect the device to a MIDI I/O port. To choose this name
properly, if you use MIDI-USB, the best is to check the device name when
connected to you machine and use a fragment of this name as the
<code>device name</code>.</p>
<p>When you have described the <code>manufacturer name</code> and the
<code>device name</code>, then you can add multiple sections. In each
section, you can add multiple <code>parameter names</code> configured
by:</p>
<ul>
<li>their CC number,</li>
<li>their min and max value (<em>optional</em>, default values are
<code>0</code> for <code>min</code> and and <code>127</code> for
<code>max</code>),</li>
<li>their init value (<em>optional</em>, which represent the value of
this parameter when the unit is freshly powered. Default value is
<code>0</code>)</li>
<li>their description (<em>optional</em>).</li>
</ul>
<p>Some of those configurations entry are optional, the only important
mandatory one is the <code>CC</code> number. The other can be omitted if
they are not different from the default values.</p>
<h3 id="a-first-version-for-the-roland-s-1">A first version for the
Roland S-1</h3>
<p>When we write a new YAML description (configuration), we need to have
the MIDI implementation chart. This is something that is provided by all
manufacturer about their product (if the device supports MIDI,
obviously). For the Roland S-1, we can find the implementation chart <a
href="https://static.roland.com/manuals/s-1_manual_v102/eng/87294690.html">here
in html</a> in their website for version <code>1.02</code> of the
firmware.</p>
<p>Now that we have a implementation chart, we need to read it a little
bit to check how it’s structured and to decide what are the different
sections that we should add. All MIDI implementation charts are not
structured the same, some already have sections for the parameters,
others no (usually they don’t), so it’s your responsibility to decide in
which section you want to sort your parameters and how you want to name
them.</p>
<p>In the implementation chart for the S-1, we can quickly identify at
least a section for the oscillators. For a first version, we will then
only add two sections: one for the oscillators, and a section that is
never explicitly added in those charts (as it is implicit) the keys/pads
section.</p>
<p>Here is a first small version of the YAML and description for Roland
S-1 which describe 2 parameters for the <code>oscillators</code> section
and the keyboard and the pitchwheel for the <code>keys</code> implicit
section:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Roland</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">S-1</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">oscillators</span><span class="kw">:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ᴧ_level</span><span class="kw">:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">19</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ꟺ_level</span><span class="kw">:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">keys</span><span class="kw">:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">notes</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;keys_or_pads&quot;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">pitchwheel</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;pitchwheel&quot;</span></span></code></pre></div>
<p>As you probably notice, the parameters in the <code>keys</code>
section are a little bit special. The <code>notes</code> parameter is
not defined by a <code>cc</code>, but is defined by
<code>"keys_or_pads</code>“, and <code>pitchwheel</code> is defined by
<code>"pitchwheel"</code>. These are specific parameters. Nallely will
know how to generate the right code for the keys to let you patch later
either the full keyboard, or specific keys. The pitchwheel will be
generated as a special element also, to let you patch the pitchwheel.
Those are necessary as, under the hood they imply:</p>
<ul>
<li>different MIDI messages that need to be sent to the MIDI
device,</li>
<li>different hooks that needs to be injected in the interruption
table,</li>
<li>a specific callback compilation at run time when those ports are
patched with any other kind of ports (CC/keys/key/pitchwheel/virtual
paramters, for curious people, check the <a
href="https://github.com/dr-schlange/nallely-midi/blob/main/nallely/core/links.py">callback
generation code</a>).</li>
</ul>
<p>Now that we have a first version, even minimal, we can generate the
code using Nallely and we can directly add it to a Nallely session:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># generate the API in s1.py</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>nallely generate -i s1.yaml -o s1.py</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu"># add it to a new session</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>nallely run --with-trevor --serve-ui -l s1.py</span></code></pre></div>
<p>That’s it, the device is now here and working, we can start to use
it, patch it with virtual devices, and patch it with other MIDI
devices.</p>
<figure>
<video src="imgs/01.mp4" controls=""><a href="imgs/01.mp4">The S-1 is
here and ready to patch!</a></video>
<figcaption aria-hidden="true">The S-1 is here and ready to
patch!</figcaption>
</figure>
<p>The <code>nallely generate</code> sub-command takes 2 parameters:
<code>-i</code> to specify the path towards the YAML configuration file,
and <code>-o</code> to specify the path towards the Python API module
that will be generated. The <code>nallely run</code> sub-commands
specify here that we want Trevor to be activated to make the session
remotly modifiable at run time, and directly served from Nallely (it
could be served from another source).</p>
<h3 id="extending-the-configuration-for-the-s-1">Extending the
configuration for the S-1</h3>
<p>Now that we have the base, we can iterate on the implementation chart
and add the missing sections:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Roland</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">S1</span><span class="kw">:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">general</span><span class="kw">:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">pan</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">10</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">poly_mode</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">oscillator</span><span class="kw">:</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ᴧ_level</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">19</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">ꟺ_level</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">20</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">filter</span><span class="kw">:</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">frequency</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">74</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">resonance</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">71</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">amp</span><span class="kw">:</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">amp_envelope_mode_sw</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">28</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">attack</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">73</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">decay</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">75</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">lfo</span><span class="kw">:</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">key_trigger</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">105</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">mode</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">79</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">chord</span><span class="kw">:</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">voice_2_sw</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">81</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">voice_2_key_shift</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">85</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">effects</span><span class="kw">:</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">reverb_level</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">91</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">reverb_time</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">cc</span><span class="kw">:</span><span class="at"> </span><span class="dv">89</span><span class="at"> </span><span class="kw">}</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">keys</span><span class="kw">:</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">notes</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;keys_or_pads&quot;</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">pitchwheel</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;pitchwheel&quot;</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co">      # ... other parameters</span></span></code></pre></div>
<p>Once we have everything, we generate the new Python API and we can
include it in a Nallely session as we did earlier:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>nallely generate -i s1.yaml -o s1.py # generate the API in s1.py</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>nallely run --with-trevor --serve-ui -l s1.py # add it to a new session</span></code></pre></div>
<figure>
<img src="imgs/02.png"
alt="We have now all the sections and parameters for the S-1" />
<figcaption aria-hidden="true">We have now all the sections and
parameters for the S-1</figcaption>
</figure>
<p><strong>NOTE</strong>: You can find the full configuration (and some
others) <a
href="https://github.com/dr-schlange/nallely-midi/tree/main/configs">here</a>
in YAML format and the generated Python module.</p>
<h3 id="conclusion-gotchas">Conclusion, gotchas</h3>
<p>This method is by far the simplest, even if - we have to be honest -
a little bit tedious. The YAML syntax is not complex to write, but the
fact that we need to go through the MIDI implementation chart, decide in
which section we want to put the parameters and write them is what I
consider tedious. Copy/paste make it easier to add new parameters, but
it’s also error prone. That probably something that we could improve
trying to <a
href="#generating-it-from-midi-implementation-chart">generate
automatically the YAML file from the MIDI implementation chart</a>
provided by the manufacturer, but that’s something that is not easy to
do.</p>
<h2 id="generate-the-python-api-from-a-csv-description">Generate the
Python API from a CSV description</h2>
<p>This way of generating the Python API uses existing kind of
harmonized description of MIDI devices from the <a
href="https://midi.guide/">MIDI CC &amp; NRPN database</a> initiative.
Even if that solution looks simpler as we don’t have to manually
describe the parameter names and their associated CCs, we show in this
section that, unfortunately, the format for the MIDI device description
is not always the same.</p>
<p><strong>NOTE</strong>: an in-depth explanation of this method is
available from <a
href="https://github.com/dr-schlange/nallely-midi/blob/main/docs/main.md#generating-a-new-configuration-for-a-device">Nallely’s
documentation</a>.</p>
<h3 id="process-overview-1">Process overview</h3>
<p>The process considers an already CSV file as input (or your own
manually crafted CSV file if you want, that you could derive from a xlsx
sheet). The CSV is passed as input of the Nallely’s generator, and the
corresponding Python API module is generated, as well as the YAML
description in the format previously described.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>CSV file --(nallely generate)--&gt; dedicated Python API</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                             +-&gt; YAML description file</span></code></pre></div>
<p>If some adjustments needs to be done, the generated Python module
shouldn’t be modified by hand, the YAML or CSV description should. Then
the code is generated again using Nallely. You have the choice to modify
either the CSV description, or the YAML one, but I would strongly
recommend to use the YAML description, it’s by far easier to modify than
the CSV (personal opinion of course).</p>
<h3 id="from-a-well-formatted-csv">From a well formatted CSV</h3>
<p>If we have a well formated CSV, as the one for the <a
href="https://midi.guide/d/korg/nts-1/">Korg NTS-1</a> or <a
href="https://midi.guide/d/korg/minilogue/">Korg Minilogue</a>, then
life is easy. We just download the corresponding CSV file, then we
generate the code, <em>et voilà</em>, we can include it in a Nallely
session:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nallely generate -i nts1.csv -o nts1.py</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>nallely run --with-trevor --serve-ui -l nts1.py</span></code></pre></div>
<p>If you load this freshly generated module in a session, you’ll see
however that there is a small catch: there is no <code>keys</code>
section. This is due to the fact that the CSV description doesn’t embed
a specific section or marker to describe the keys and the pitchwheel
(which makes totally sense). Consequently, if we want to have this
section, we have to modify the YAML description that was generated from
the initial CSV and to add the missing section as we did previously in
this article. Once we added the missing section, we can, once again,
generate the Python API code from the YAML description, and forget about
the CSV as we have the YAML file for further modifications (if
needed).</p>
<h3 id="from-a-badly-formatted-csv">From a badly formatted CSV</h3>
<p>All the problem of this method is really this case… What happens when
we have a badly formatted CSV? The <a
href="https://midi.guide/d/roland/s-1/">CSV for the Roland S-1</a> is a
good example. It seems that it was directly produced from the html MIDI
implementation chart from Roland’s website, but it doesn’t conform to
the <a
href="https://raw.githubusercontent.com/pencilresearch/midi/main/template.csv">syntax/format
recommended by the MIDI CC &amp; NRPN database</a>. Let’s generate the
code and see what’s happening:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>$ nallely generate -i s1.csv -o bads1.py</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>$ cat bads1.py</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>&quot;&quot;</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Generated configuration for the Roland - S-1</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>&quot;&quot;&quot;</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>import nallely</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>class All_ccsSection(nallely.Module):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    modulation_wheel = nallely.ModuleParameter(1)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    lfo_rate_(lfo_<span class="co">[</span><span class="ot">rate</span><span class="co">]</span>_knob) = nallely.ModuleParameter(3)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    # ...</span></code></pre></div>
<p>… that’s not great.. We can see that the name of the class that will
represent a section is weird, and that the names of the parameters are
sometimes wrong (they have <code>(</code> and other special characters).
On another note, we can see also is that the Python API is not that
complicated to read or write (beside the parameters name being wrong).
We have a <code>class</code> that inherits from
<code>nallely.Module</code>, then class variables that are instances of
<code>nallely.ModuleParameters</code>. That’s it for the basic, and the
missing “glue” code is not that much more complicated.</p>
<p>Anyway, what we can see is that the generated code is not right,
there is no well defined sections, the parameter names are bad… We
definitely cannot use it, and modifying the Python code by hand is
definitely not a good option. In this case, there is no other choice
than producing the YAML configuration by hand…</p>
<h3 id="conclusion-gotchas-1">Conclusion, gotchas</h3>
<p>This method is a good one when we have the chance to have a well
formated CSV. Consequently, before writing a YAML configuration by hand,
it’s recommended to check on the MIDI CC &amp; NRPN database website if
there is a CSV configuration for your device, then if the CSV is well
formatted or not. Depending on that, you’ll know if you can bootstrap
your YAML description from the CSV or if you need to go by hand writing
your YAML description.</p>
<h2 id="write-the-python-api-by-hand">Write the Python API by hand</h2>
<p>This method is not complicated per say, but it implies to manipulate
the internal Python DSL to describe MIDI devices by hand. This method is
described in depth in <a
href="https://github.com/dr-schlange/nallely-midi/blob/main/docs/main.md#define-a-new-configuration-for-a-device-programmatically">Nallely’s
documentation</a>, and while it’s a perfectly fine method to use, I
wouldn’t recommend it, just in case the internal DSL moves a lot between
versions (even if it should always be retro-compatible).</p>
<h3 id="process-overview-2">Process overview</h3>
<p>This method removes the need to generate code from a YAML/CSV
description. You basically cut the middle man and just manually describe
your MIDI device configuration using the internal Python DSL. As you are
directly writing the Python module, you can directly load your code in a
Nallely session:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>Python module file --(manual modification)--&gt; new version of the dedicated Python API</span></code></pre></div>
<h3 id="describing-your-device">Describing your device</h3>
<p>Without entering in too much details (please refer to the in-depth <a
href="https://github.com/dr-schlange/nallely-midi/blob/main/docs/main.md#define-a-new-configuration-for-a-device-programmatically">documentation</a>
about this method), basically:</p>
<ul>
<li>a device is a class that inherits from
<code>nallely.MidiDevice</code>;</li>
<li>sections are classes that inherit from
<code>nallely.Module</code>;</li>
<li>parameters are class variables that are instances of
<code>nallely.ModuleParameters</code>;</li>
<li>the keyboard is a class variable in a section that is instance of
<code>nallely.ModulePadsOrKeys</code>;</li>
<li>the pitchweel is a class variable in a section that is instance of
<code>nallely.ModulePitchwheel</code>;</li>
<li>sections are inserted in a device as class variable of the
device;</li>
<li>Python <code>@property</code> are used inside the device class as
shortcuts toward sections.</li>
</ul>
<p>If you want to have an overview of how the code is structured, you
can check any configuration of the builtins devices inside Nallely or
the onces that are are in <code>configs</code> folder (e.g:
configuration for the <a
href="https://github.com/dr-schlange/nallely-midi/blob/main/configs/behringer-provs-mini.py">Behringer
Pro-VS Mini</a>).</p>
<h3 id="conclusion-gotchas-2">Conclusion, gotchas</h3>
<p>This way of doing, while not being complicated, is perhaps the less
recommended. The internal Python DSL is not hard to understand and to
use, but writing the section shortcut after the
<code>__init__(...)</code> method is annoying and error-prone. It’s
definitely better to let that to a code generator.</p>
<h2 id="what-could-be-improved">What could be improved?</h2>
<p>The three described methods are not complicated to deal with, but -
in my opinion - they could be improved. I’ll be honest, currently, I’m
not sure what would be the best way to improve that. Here is some ideas
about how they could be, and why, but I’m still not convinced by those
methods at the moment.</p>
<h3 id="make-it-interactive">Make it interactive?</h3>
<p>A good way of dealing with this would be to make the “ingestion”
process a little bit more interactive following this process:</p>
<ol type="1">
<li>from the interface a new button let you “aquire” a device;</li>
<li>in this mode the interface could ask the user to tweak a button
then:
<ol type="1">
<li>associate it:
<ul>
<li>to a new section</li>
<li>associate it a an existing section</li>
</ul></li>
<li>name it</li>
</ol></li>
<li>loop from 2 until there is nothing more to aquire.</li>
</ol>
<p>Even if this solution might seems interesting, there is - still in my
opinion - three major flaws:</p>
<ol type="1">
<li>we need to constantly swap from “tweaking a button” to “typing
information using the keyboard” =&gt; that’s annoying, I don’t like
that;</li>
<li>we need to handle section creations and selection from the interface
=&gt; there is probably good ways of doing it, but that’s not so amazing
as we don’t have a full global vision of all the parameters, we cannot
sort them properly, so we need to be able to add/select/remove sections.
Nothing impossible, just, at the end, not that amazing;</li>
<li>we need to pass manually through all the CCs and depending on the
MIDI device, it might be really tedious, especially for devices that
have a lot of menus/sub-menus.</li>
</ol>
<p>Among those flaws, the biggest annoying part would be the first
point: having to pass from tweaking a button, to the keyboard to enter
information. We could slick that by letting the user tweak all the
buttons at once <em>then</em> enter information. Doing this reduces the
necessity to switch from one place to the other, but when all the
parameters are aquired, it might be really difficult to remember to
which parameter was refering a specific CC, and going through all the
buttons, depending on the MIDI device, might also be painful.</p>
<h3 id="generating-it-from-midi-implementation-chart">Generating it from
MIDI implementation chart?</h3>
<p>A way to simplify the aquisition of new MIDI devices could be to try
to generate the input YAML file directly from the MIDI implementation
chart provided by the manufacturer. After all, the MIDI implementation
chart is provided and shouldn’t contain any error, so it would be
easier. That’s true, but here is the catch: they don’t have all the same
format. They have a “somehow” same format, but it’s not exactly the
same, and it varies a lot depending on the company. As example, just
look at some implementation charts made by Roland, and some made by
Behringer. While we find the same kind of information inside - more or
less - they are structured really differently. Same story if we go to
Korg: a somehow equivalent looking implementation chart, but not exactly
the same. On top of that, it’s not even sure that the implementation
charts have the same format between devices of a same brand. That’s why
the initiative “MIDI CC &amp; NRPN database” initiative is so
interesting: they try to harmonize everything. Unfortunately, they
sometimes fall short in having everything well formated. I’m not
pointing fingers or criticizing, it’s a complicated task and it relies a
lot on how careful are contributors to match the recommended format.</p>
<h3 id="automatic-fetch-configuration-files-from-a-remote-db">Automatic
fetch configuration files from a remote DB?</h3>
<p>This would be the best: you just search from the command line for
your device, then, when you identified it, Nallely automatically
downloads the MIDI chart, generates the Python API code and integrates
it at run time in the running session. Technically, there is no blocking
part, all is easy to do, but the only problem is “where do I find 100%
harmonized version of MIDI implementation charts in a format that is
easy to parse?”. As we saw in this article, there is only one initiative
that goes in this direction, but the result highly depends on the CSV
description that is not always formatted the same. There is so much
variations between configurations that it makes it complicated to
consider some general format exceptions, and it’s not a good idea to
start to have some. Indeed, if we start having some rules exceptions, as
those exceptions are “per device” dependent (exactly, per contributor
dependent), then we would need to support all small variations. It would
be weird to only support some variations, but not all of them… So, at
the end, this alternative is not currently viable.</p>

        <!-- Page Footer -->
        <div class="footer">
                <p>Built with <a href="https://github.com/spectrasecure/arise">Arise</a>, a cloud-native static site generator written in Bash.</p>
        </div>
        <!-- End Page Footer -->

</body>
</html>
