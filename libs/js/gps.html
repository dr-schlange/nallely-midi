<!--
THIS FILE IS ENTIRELY GENERATED BY AN LLM FOR QUICK BOOTSTRAP
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.jsdelivr.net/gh/dr-schlange/nallely-midi@main/libs/js/nallely-websocket.js"></script>

    <title>GPS Sequencer Source</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: monospace;
        }

        table {
            border-collapse: collapse;
            margin-top: 1em;
        }

        td {
            padding: 4px 8px;
            border-bottom: 1px solid #ccc;
        }

        td.value {
            text-align: right;
            min-width: 120px;
        }
    </style>
</head>

<body>

    <button id="start">Start GPS</button>

    <table id="monitor"></table>

    <script>
        /* ---------------------------------------------
           CONFIGURATION
        --------------------------------------------- */

        const configParameters = {
            latitude: { min: -90.0, max: 90.0 },
            longitude: { min: -180.0, max: 180.0 },
            altitude: { min: -500.0, max: 10000.0 },
            speed: { min: 0.0, max: 100.0 },
            heading: { min: 0.0, max: 360.0 },
            accuracy: { min: 0.0, max: 1000.0 },

            deltaLat: { min: -1.0, max: 1.0 },
            deltaLon: { min: -1.0, max: 1.0 },

            distance: { min: 0.0, max: 1.0 },
            headingDelta: { min: -180.0, max: 180.0 },
            speedDelta: { min: -50.0, max: 50.0 },
            movementState: { min: 0.0, max: 1.0 }
        };

        const config = Object.fromEntries(
            Object.keys(configParameters).map(k => [k, 0.0])
        );

        /* ---------------------------------------------
           DEVICE REGISTRATION
        --------------------------------------------- */

        const device = NallelyWebsocketBus.register(
            'navigation',
            'gps',
            configParameters,
            config,
        );

        /* ---------------------------------------------
           UI MONITOR SETUP
        --------------------------------------------- */

        const monitor = document.getElementById("monitor");
        const fields = Object.keys(configParameters);
        const ui = {};

        fields.forEach(name => {
            const row = document.createElement("tr");
            const label = document.createElement("td");
            const value = document.createElement("td");

            label.textContent = name;
            value.textContent = "0.0";
            value.className = "value";

            row.appendChild(label);
            row.appendChild(value);
            monitor.appendChild(row);

            ui[name] = value;
        });

        function updateUI(name, value) {
            if (ui[name]) {
                ui[name].textContent = value.toFixed(6);
            }
        }

        /* ---------------------------------------------
           GPS STATE
        --------------------------------------------- */

        let lastLat = null;
        let lastLon = null;
        let lastHeading = null;
        let lastSpeed = null;

        /* ---------------------------------------------
           GPS HANDLING
        --------------------------------------------- */

        function startGPS() {
            if (!navigator.geolocation) {
                alert("Geolocation not supported by your browser.");
                return;
            }

            navigator.geolocation.watchPosition(
                position => {
                    const c = position.coords;

                    const lat = c.latitude;
                    const lon = c.longitude;
                    const speed = c.speed ?? 0.0;
                    const heading = c.heading ?? 0.0;

                    const deltaLat = (lastLat !== null) ? lat - lastLat : 0.0;
                    const deltaLon = (lastLon !== null) ? lon - lastLon : 0.0;
                    const distance = Math.sqrt(deltaLat * deltaLat + deltaLon * deltaLon);

                    let headingDelta = 0.0;
                    if (lastHeading !== null) {
                        headingDelta = heading - lastHeading;
                        if (headingDelta > 180) headingDelta -= 360;
                        if (headingDelta < -180) headingDelta += 360;
                    }

                    const speedDelta = (lastSpeed !== null) ? speed - lastSpeed : 0.0;
                    const movementState = speed > 0.5 ? 1.0 : 0.0;

                    lastLat = lat;
                    lastLon = lon;
                    lastHeading = heading;
                    lastSpeed = speed;

                    const send = (name, value) => {
                        device.send(name, value);
                        updateUI(name, value);
                    };

                    send("latitude", lat);
                    send("longitude", lon);
                    send("altitude", c.altitude ?? 0.0);
                    send("speed", speed);
                    send("heading", heading);
                    send("accuracy", c.accuracy);

                    send("deltaLat", deltaLat);
                    send("deltaLon", deltaLon);
                    send("distance", distance);
                    send("headingDelta", headingDelta);
                    send("speedDelta", speedDelta);
                    send("movementState", movementState);
                },
                err => console.error("GPS error:", err),
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                }
            );
        }

        /* ---------------------------------------------
           USER GESTURE
        --------------------------------------------- */

        document.getElementById("start")
            .addEventListener("click", startGPS);
    </script>

</body>

</html>